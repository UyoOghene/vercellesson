<% layout('layouts/boilerplate') -%>

<div id="showcontainer">
    <h1 class="text"><%= post.title %></h1>
    
    <!-- Post author info -->
    <p>Post created by 
        <% if (post.author) { %>
            <%= post.author.username %> on <%= post.createdAt.toLocaleDateString() %> by 

        <% } else { %>
            [deleted user]
        <% } %>
    </p>
    
    <!-- Post image and caption -->
    <img src="<%= post.image.startsWith('/') ? post.image : '/' + post.image %>">
    <p class="text"><%= post.caption %></p>

    <form action="/posts/<%= post._id %>/like" method="POST" class="d-inline">
        <button  id="likebtn" >
            <img id="heartimg" 
            src="<%= post.likes.includes(currentUser && currentUser._id) ? '/images/heart.png' : '/images/emptyheart.jpg' %>" 
            alt="heart">
                   </button>
        <span id="likecount"><%= post.likes.length %> Likes</span>
    </form>


    <!-- Edit/Delete buttons (only show if current user is post author) -->
    <% if (currentUser && post.author && currentUser._id.equals(post.author._id)) { %>
        <div id="editndel">
            <a href="/posts/<%= post._id %>/edit" class="edit-btn">
                <img id="editimg" src="/images/edit2.png" alt="Edit">
            </a>
            <form action="/posts/<%= post._id %>?_method=DELETE" method="post">
                <button type="submit" class="delete-btn">
                    <img id="delbtn" src="/images/delete.png" alt="Delete">
                </button>
            </form>
        </div>
    <% } %>

    <!-- Comment form -->
    <% if (currentUser) { %>
        <form class="comment-form" action="/posts/<%= post._id %>/comments" method="post">
            <label for="body">Add a Comment</label>
            <textarea name="comment[body]" id="body" required></textarea>
            <button type="submit">Post Comment</button>
        </form>
    <% } else { %>
        <p class="login-prompt">You must <a href="/login">log in</a> to comment.</p>
    <% } %>

    <!-- Comments section -->
    <% if (post.comments && post.comments.length > 0) { %>
        <div class="comments-section">
            <h3>Comments</h3>
            
            <% post.comments.forEach(comment => { %>
                <div class="comment">
                    <p><%= comment.body %></p>
                    <small>
                        <%= comment.createdAt.toLocaleDateString() %> by 
                        <% if (comment.author) { %>
                            <%= comment.author.username || comment.author.email %>
                        <% } else { %>
                            [deleted user]
                        <% } %>
                    </small>
                    
                    <% if (currentUser && comment.author && currentUser._id.equals(comment.author._id)) { %>
                        <form action="/posts/<%= post._id %>/comments/<%= comment._id %>?_method=DELETE" method="post">
                            <button type="submit" class="delete-comment-btn">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </form>
                    <% } %>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <p class="login-prompt">No comments yet.</p>
    <% } %>

    <a class="text" href="/posts">Back to all posts</a>
</div>